# .env Configuration Validation Report

**Generated:** 2025-01-XX  
**Status:** ⚠️ INCOMPLETE - Missing Critical Variables

## Executive Summary

Your `.env` file is **INCOMPLETE** for the NFT verification onboarding system. The following critical variables are **MISSING**:

- ❌ `DISCORD_CLIENT_SECRET` - Required for OAuth token exchange
- ❌ `MINT_AUTHORITY_KEYPAIR` - Required for NFT minting
- ❌ `API_BASE_URL` - Required for frontend API calls
- ❌ `VERIFIED_COLLECTION_ADDRESS` - Required for NFT collection

## Current .env Analysis

### ✅ PRESENT Variables

| Variable | Value | Status | Purpose |
|----------|-------|--------|---------|
| `DISCORD_CLIENT_ID` | `1419742988128616479` | ✅ Valid | Discord OAuth client ID |
| `MONGODB_URI` | `mongodb+srv://justhetip...` | ✅ Valid | MongoDB Atlas connection |
| `MONGO_CERT_PATH` | `X509-cert-1238302248811631245.pem` | ⚠️ Verify file exists | X.509 certificate for MongoDB |
| `SOLANA_RPC_URL` | `https://api.mainnet-beta.solana.com` | ✅ Valid | Solana RPC endpoint |
| `NODE_ENV` | `mainnet` | ✅ Valid | Environment flag |
| `BOT_TOKEN` | `MTQxOTc0Mjk4ODEyODYx...` | ✅ Valid | Discord bot token |

### ❌ MISSING Variables (CRITICAL)

#### 1. DISCORD_CLIENT_SECRET
**Purpose:** OAuth2 token exchange in `api/server.js`  
**Required By:** `POST /api/discord/token` endpoint  
**How to Obtain:**
```bash
# Go to Discord Developer Portal
# https://discord.com/developers/applications/1419742988128616479/oauth2
# Copy "CLIENT SECRET" value
```

**Add to .env:**
```env
DISCORD_CLIENT_SECRET=YOUR_SECRET_HERE
```

#### 2. MINT_AUTHORITY_KEYPAIR
**Purpose:** Solana keypair for minting NFTs  
**Required By:** `api/server.js` NFT minting endpoint  
**How to Generate:**
```bash
# Generate new keypair
solana-keygen new --outfile mint-authority.json --no-bip39-passphrase

# Convert to base58 array for .env
node -e "const fs = require('fs'); const keypair = JSON.parse(fs.readFileSync('mint-authority.json')); console.log(JSON.stringify(Array.from(keypair)));"
```

**Add to .env:**
```env
MINT_AUTHORITY_KEYPAIR=[1,2,3,4,...,64]
```

**⚠️ SECURITY WARNING:**
- Keep this keypair EXTREMELY secure
- Fund with enough SOL for NFT minting (~0.01 SOL per mint + rent)
- Never commit to Git
- Consider using environment-specific vault (AWS Secrets Manager, etc.)

#### 3. API_BASE_URL
**Purpose:** Backend API URL for frontend calls  
**Required By:** `docs/landing-app.js` API requests  
**Values:**

**For Local Testing:**
```env
API_BASE_URL=http://localhost:5500
```

**For Production (Railway/Render):**
```env
API_BASE_URL=https://your-app.railway.app
# or
API_BASE_URL=https://justthetip-api.onrender.com
```

#### 4. VERIFIED_COLLECTION_ADDRESS
**Purpose:** Verified NFT collection address for on-chain queries  
**Required By:** `utils/verificationChecker.js` ownership verification  
**How to Obtain:**

**Option A - Create Collection NFT:**
```bash
# Use Metaplex Sugar CLI
npm install -g @metaplex-foundation/sugar
sugar create-collection
# Follow prompts, save collection address
```

**Option B - Use Existing Collection:**
```bash
# If you already have collection, add its mint address
```

**Add to .env:**
```env
VERIFIED_COLLECTION_ADDRESS=YourCollectionMintAddress
```

### ⚠️ OPTIONAL Variables (Recommended)

#### PORT (Backend Server Port)
**Default:** 5500  
**Purpose:** Express server listening port  
```env
PORT=5500
```

#### CORS_ORIGIN (CORS Whitelist)
**Default:** `*` (all origins)  
**Purpose:** Security - limit which domains can call your API  
```env
CORS_ORIGIN=https://jmenichole.github.io
```

## Configuration Roadmap

### Step 1: Get Discord Client Secret
1. Visit https://discord.com/developers/applications/1419742988128616479/oauth2
2. Click "Reset Secret" (if first time) or "Copy"
3. Add to `.env` as `DISCORD_CLIENT_SECRET=...`

### Step 2: Generate Mint Authority Keypair
```bash
# Generate keypair
solana-keygen new --outfile /Users/fullsail/justthetip/security/mint-authority.json --no-bip39-passphrase

# View public key
solana-keygen pubkey /Users/fullsail/justthetip/security/mint-authority.json

# Fund it (need ~0.5-1 SOL for testing)
# Transfer SOL from your main wallet to this address

# Convert to base58 array
node -e "const fs = require('fs'); const keypair = JSON.parse(fs.readFileSync('/Users/fullsail/justthetip/security/mint-authority.json')); console.log('MINT_AUTHORITY_KEYPAIR=' + JSON.stringify(Array.from(keypair)));"
```

### Step 3: Set API Base URL
```bash
# For local testing
echo "API_BASE_URL=http://localhost:5500" >> .env

# Update docs/landing-app.js CONFIG object to use this
```

### Step 4: Create NFT Collection (Optional but Recommended)
```bash
# Install Metaplex CLI
npm install -g @metaplex-foundation/sugar

# Create collection metadata
mkdir -p /Users/fullsail/justthetip/nft-collection
cd /Users/fullsail/justthetip/nft-collection

# Create collection config
cat > collection.json << 'EOF'
{
  "name": "JustTheTip Verified Users",
  "symbol": "JTTVERIFY",
  "description": "Verified user badge for JustTheTip Discord bot",
  "image": "https://gateway.pinata.cloud/ipfs/bafybeihdwvqhzw3zaecne4o43mtoan23sc5janjgtnqvdrds5qkjk6lowu/logo.png",
  "external_url": "https://jmenichole.github.io/Justthetip",
  "seller_fee_basis_points": 0,
  "properties": {
    "category": "image"
  }
}
EOF

# Create collection (requires SOL)
sugar create-collection --config collection.json --keypair /Users/fullsail/justthetip/security/mint-authority.json

# Copy the output collection address to .env
```

## Required File Structure

```
/Users/fullsail/justthetip/
├── .env                              ← Update with missing variables
├── .env.example                      ← Create for documentation
├── api/
│   └── server.js                     ← Backend API (needs DISCORD_CLIENT_SECRET, MINT_AUTHORITY_KEYPAIR)
├── docs/
│   ├── landing-app.js                ← Frontend (needs API_BASE_URL)
│   └── landing_NEW.html              ← Landing page with modals
├── utils/
│   └── verificationChecker.js        ← Bot middleware (needs VERIFIED_COLLECTION_ADDRESS)
├── security/
│   ├── mint-authority.json           ← Generate this keypair
│   └── X509-cert-1238302248811631245.pem  ← Verify this exists
└── nft-collection/                   ← Create for collection metadata
    └── collection.json
```

## Verification Checklist

### Before Backend Deployment
- [ ] `DISCORD_CLIENT_SECRET` added to `.env`
- [ ] `MINT_AUTHORITY_KEYPAIR` generated and added to `.env`
- [ ] Mint authority wallet funded with 0.5-1 SOL
- [ ] `VERIFIED_COLLECTION_ADDRESS` created and added to `.env`
- [ ] `API_BASE_URL` configured for target environment
- [ ] `MONGODB_URI` connection tested
- [ ] `MONGO_CERT_PATH` file exists and readable
- [ ] `.env` file never committed to Git (check `.gitignore`)

### After Backend Deployment
- [ ] Update `API_BASE_URL` in `docs/landing-app.js` CONFIG
- [ ] Test `/api/health` endpoint
- [ ] Test `/api/mintBadge` with mock data
- [ ] Test `/api/discord/token` with OAuth code
- [ ] Test `/api/verification/:discordId` lookup

### Frontend Configuration
- [ ] `landing-app.js` CONFIG.API_BASE_URL updated
- [ ] `landing-app.js` CONFIG.DISCORD_CLIENT_ID matches `.env`
- [ ] `landing_NEW.html` renamed to `landing.html` (or update GitHub Pages config)
- [ ] Terms version matches backend expectations
- [ ] All modals functional in browser

### Bot Integration
- [ ] `utils/verificationChecker.js` imported in `bot.js`
- [ ] `requireVerification()` middleware added to commands
- [ ] Database connection tested
- [ ] NFT ownership verification tested
- [ ] Cache system tested

## Quick Start Commands

### 1. Validate MongoDB Connection
```bash
node -e "const { MongoClient } = require('mongodb'); const client = new MongoClient(process.env.MONGODB_URI); client.connect().then(() => { console.log('✅ MongoDB Connected'); client.close(); }).catch(err => console.error('❌ Error:', err.message));"
```

### 2. Test Solana RPC
```bash
curl https://api.mainnet-beta.solana.com -X POST -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"getHealth"}'
```

### 3. Start Backend API (After Config)
```bash
cd /Users/fullsail/justthetip
node api/server.js
```

### 4. Test Backend Health
```bash
curl http://localhost:5500/api/health
```

## Environment-Specific Configs

### .env.local (Local Development)
```env
NODE_ENV=development
API_BASE_URL=http://localhost:5500
SOLANA_RPC_URL=https://api.devnet.solana.com
PORT=5500
CORS_ORIGIN=*
```

### .env.production (Deployment)
```env
NODE_ENV=production
API_BASE_URL=https://your-app.railway.app
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
PORT=5500
CORS_ORIGIN=https://jmenichole.github.io
```

## Security Best Practices

### 1. Secrets Management
- ❌ Never commit `.env` to Git
- ✅ Use `.env.example` with dummy values for documentation
- ✅ Use environment variable vaults for production (Railway, Render, AWS Secrets Manager)
- ✅ Rotate secrets regularly (especially Discord tokens)

### 2. Keypair Security
- ❌ Never expose `MINT_AUTHORITY_KEYPAIR` in logs or error messages
- ✅ Store keypair files outside web root
- ✅ Limit keypair wallet to minimum required SOL
- ✅ Monitor keypair wallet for unauthorized transactions

### 3. API Security
- ✅ Use CORS_ORIGIN whitelist in production
- ✅ Implement rate limiting on `/api/mintBadge`
- ✅ Validate Discord OAuth state parameter
- ✅ Verify wallet signatures before minting

### 4. MongoDB Security
- ✅ Use X.509 authentication (you're already doing this)
- ✅ Limit database user permissions
- ✅ Enable MongoDB audit logging
- ✅ Regularly backup verifications collection

## Troubleshooting

### Error: "DISCORD_CLIENT_SECRET is not set"
**Fix:** Add client secret from Discord Developer Portal to `.env`

### Error: "Invalid MINT_AUTHORITY_KEYPAIR"
**Fix:** Ensure keypair is valid base58 array: `[1,2,3,...,64]`

### Error: "Failed to connect to MongoDB"
**Fix:** Verify `MONGO_CERT_PATH` file exists and `MONGODB_URI` is correct

### Error: "Insufficient funds for NFT minting"
**Fix:** Fund mint authority wallet with SOL:
```bash
solana balance <MINT_AUTHORITY_PUBLIC_KEY>
solana transfer <MINT_AUTHORITY_PUBLIC_KEY> 1 --from <YOUR_MAIN_WALLET>
```

### Error: "API_BASE_URL undefined in frontend"
**Fix:** Update `docs/landing-app.js` CONFIG object with backend URL

### Error: "CORS policy blocked request"
**Fix:** Add frontend domain to `CORS_ORIGIN` in backend `.env`

## Next Steps

1. **Immediate:** Add missing variables to `.env` (see sections above)
2. **Generate:** Create mint authority keypair and fund it
3. **Test:** Run backend locally with `node api/server.js`
4. **Mock Test:** Run mock test script (see `.env.mock-test.js`)
5. **Deploy:** Deploy backend to Railway/Render
6. **Configure Frontend:** Update API_BASE_URL in landing-app.js
7. **Activate:** Rename landing_NEW.html to landing.html
8. **Integrate:** Add verificationChecker to bot commands
9. **Production:** Test complete flow end-to-end
10. **Monitor:** Set up logging and error tracking

## Support Resources

- **Discord Developer Portal:** https://discord.com/developers/applications
- **Metaplex Docs:** https://docs.metaplex.com/
- **Solana CLI Docs:** https://docs.solana.com/cli
- **MongoDB Atlas:** https://cloud.mongodb.com/
- **Railway Deployment:** https://railway.app/
- **Render Deployment:** https://render.com/

---

**Last Updated:** 2025-01-XX  
**Configuration Status:** ⚠️ INCOMPLETE - 4 critical variables missing  
**Ready for Production:** ❌ No - Complete configuration first
