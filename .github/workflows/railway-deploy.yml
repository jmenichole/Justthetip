name: Deploy to Railway

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (bot or api)'
        required: true
        default: 'bot'
        type: choice
        options:
          - bot
          - api

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

permissions:
  contents: read

jobs:
  deploy-bot:
    name: Deploy Discord Bot to Railway
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[deploy-bot]')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.service == 'bot')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Install Railway CLI
        run: |
          echo "Installing Railway CLI..."
          npm install -g @railway/cli
          railway --version

      - name: Link to Railway Project
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Linking to Railway project..."
          railway link --projectId=${{ secrets.RAILWAY_PROJECT_ID }}
          echo "✅ Successfully linked to Railway project"

      - name: Set Environment Variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Setting environment variables..."
          railway variables set DISCORD_BOT_TOKEN="${{ secrets.DISCORD_BOT_TOKEN }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set DISCORD_CLIENT_ID="${{ secrets.DISCORD_CLIENT_ID }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set FRONTEND_URL="${{ secrets.FRONTEND_URL }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set API_BASE_URL="${{ secrets.API_BASE_URL }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set GUILD_ID="${{ secrets.GUILD_ID }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set HELIUS_API_KEY="${{ secrets.HELIUS_API_KEY }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set SOLANA_RPC_URL="${{ secrets.SOLANA_RPC_URL }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set SOL_RPC_URL="${{ secrets.SOL_RPC_URL }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set MONGODB_URI="${{ secrets.MONGODB_URI }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set DATABASE_URL="${{ secrets.DATABASE_URL }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set NODE_ENV="production" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set SUPER_ADMIN_USER_IDS="${{ secrets.SUPER_ADMIN_USER_IDS }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set ADMIN_USER_IDS="${{ secrets.ADMIN_USER_IDS }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set SUPER_ADMIN_SECRET="${{ secrets.SUPER_ADMIN_SECRET }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          railway variables set EMERGENCY_ADMIN_SECRET="${{ secrets.EMERGENCY_ADMIN_SECRET }}" --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          echo "✅ Environment variables configured successfully"

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying bot service..."
          railway up --serviceId=${{ secrets.RAILWAY_BOT_SERVICE_ID }}
          echo "✅ Bot service deployed"

      - name: Verify Deployment
        run: |
          echo "✅ Bot deployed successfully to Railway!"
          echo "Service: ${{ secrets.RAILWAY_BOT_SERVICE_ID }}"
          echo "Railway will complete deployment after GitHub Actions finish"
          echo "Check Railway dashboard for deployment status"

  deploy-api:
    name: Deploy API Server to Railway
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[deploy-api]')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.service == 'api')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Install Railway CLI
        run: |
          echo "Installing Railway CLI..."
          npm install -g @railway/cli
          railway --version

      - name: Link to Railway Project
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Linking to Railway project..."
          railway link --projectId=${{ secrets.RAILWAY_PROJECT_ID }}
          echo "✅ Successfully linked to Railway project"

      - name: Set Environment Variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Setting environment variables..."
          railway variables set DISCORD_CLIENT_ID="${{ secrets.DISCORD_CLIENT_ID }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set DISCORD_CLIENT_SECRET="${{ secrets.DISCORD_CLIENT_SECRET }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set DISCORD_REDIRECT_URI="${{ secrets.DISCORD_REDIRECT_URI }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set SOLANA_RPC_URL="${{ secrets.SOLANA_RPC_URL }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set MINT_AUTHORITY_KEYPAIR="${{ secrets.MINT_AUTHORITY_KEYPAIR }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set MONGODB_URI="${{ secrets.MONGODB_URI }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set PORT="3000" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set NODE_ENV="production" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set CORS_ORIGIN="${{ secrets.CORS_ORIGIN }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set MAGIC_PUBLISHABLE_KEY="${{ secrets.MAGIC_PUBLISHABLE_KEY }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set MAGIC_SECRET_KEY="${{ secrets.MAGIC_SECRET_KEY }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set REGISTRATION_TOKEN_SECRET="${{ secrets.REGISTRATION_TOKEN_SECRET }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set MAGIC_SOLANA_NETWORK="${{ secrets.MAGIC_SOLANA_NETWORK }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          railway variables set MAGIC_SOLANA_RPC_URL="${{ secrets.MAGIC_SOLANA_RPC_URL }}" --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          echo "✅ Environment variables configured successfully"

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying API service..."
          railway up --serviceId=${{ secrets.RAILWAY_API_SERVICE_ID }}
          echo "✅ API service deployed"

      - name: Verify Deployment
        run: |
          echo "✅ API deployed successfully to Railway!"
          echo "Service: ${{ secrets.RAILWAY_API_SERVICE_ID }}"
          echo "Railway will complete deployment after GitHub Actions finish"
          echo "Check Railway dashboard for deployment status"
